<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<title>Edit Fic: {{ fic.title }}</title>
<link rel="icon" href="{{ url_for('static', filename='favicon.webp') }}" type="image/x-icon" />
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
<div class="full-container">
    <div class="site-header">

        <button
            type="button"
            id="theme-toggle"
            aria-label="Toggle dark mode"
            style="
                background: none;
                border: none;
                cursor: pointer;
                display: flex;
                align-items: center;
            "
        >
            <!-- Sun icon -->
            <svg
                id="icon-sun"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                style="display: inline"
            >
                <circle
                    cx="12"
                    cy="12"
                    r="5"
                    fill="currentColor"
                ></circle>
                <g stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line
                        x1="4.22"
                        y1="4.22"
                        x2="5.64"
                        y2="5.64"
                    ></line>
                    <line
                        x1="18.36"
                        y1="18.36"
                        x2="19.78"
                        y2="19.78"
                    ></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line
                        x1="4.22"
                        y1="19.78"
                        x2="5.64"
                        y2="18.36"
                    ></line>
                    <line
                        x1="18.36"
                        y1="5.64"
                        x2="19.78"
                        y2="4.22"
                    ></line>
                </g>
            </svg>
            <!-- Moon icon -->
            <svg
                id="icon-moon"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                style="display: none"
            >
                <path
                    d="M21 12.79A9 9 0 0112.21 3a7 7 0 100 14 9 9 0 008.79-4.21z"
                    fill="currentColor"
                ></path>
            </svg>
        </button>
        {% if logged_in %}
        <p>
            Logged in as <a href="{{ url_for('profile') }}">{{ session['username'] }}</a> --- <a href="{{ url_for('logout') }}">Logout</a>
        </p>
        {% else %}
        <p>
            <a href="{{ url_for('login') }}">Login</a> --- <a href="{{ url_for('register') }}">Register</a>
        </p>
        {% endif %}
    </div>

    <div class="container-1">
        <h1>Edit {{ fic.title }}</h1>
        <!-- Main form for editing fanfic -->
        <form method="POST" id="edit-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <label>Title</label><br />
            <input type="text" name="title" value="{{ fic.title }}" required /><br />

            <label>Fandom</label><br />
            <input type="text" name="fandom" value="{{ fic.fandom }}" required /><br />
            <!-- Handle empty or present chapters, defaulting to first chapter if exists -->
            {% set first_chapter = chapters[0] if chapters and chapters|length > 0 else {'title': '', 'content': ''} %}


            <label>Content</label><br />
           <textarea name="content" rows="10">{{ fic.content }}</textarea>

            <!-- Tags section -->
            <div class="submit-tags">
                <div class="tags-input-container" style="margin-top: 20px;">
                    <label for="tags-input">Tags</label><br />
                    <input
                        type="text"
                        id="tags-input"
                        placeholder="Type tags and press Enter or comma"
                        autocomplete="off"
                    />
                    <div id="tags-container" style="margin-top: 10px;"></div>
                    <input type="hidden" name="tags" id="tags-hidden" />
                </div>
                <br />
                <label for="age_rating">Age Rating:</label>
                <select name="age_rating" id="age_rating" required>
                    <option value="">Select age rating</option>
                    <option value="18+" {% if fic.age_rating == "18+" %}selected{% endif %}>18+</option>
                    <option value="16+" {% if fic.age_rating == "16+" %}selected{% endif %}>16+</option>
                    <option value="13+" {% if fic.age_rating == "13+" %}selected{% endif %}>13+</option>
                </select>
                <br /><br />
                <!-- Submit button for main form -->
                <button type="submit">Save Changes</button>
            </form>

            <!-- Separate form for delete -->
            <form method="POST" action="{{ url_for('delete_fic', fic_id=fic.id) }}" style="margin-top: 10px;">
                <button
                    type="submit"
                    style="background-color: darkred; color: white"
                    onclick="return confirm('Are you sure you want to delete this fanfic?');"
                >
                    Delete Fanfic
                </button>
            </form>
        </div>
    </div>

    <div class="site-footer">
        <p>
            <a href="{{ url_for('index') }}">Index</a>
            {% if logged_in %}-- <a href="{{ url_for('logout') }}">Logout</a>{% endif %}
            {% if is_owner %} -- <a href="{{ url_for('edit_profile') }}">Edit Profile</a>{% endif %}
            {% if is_admin %} -- <a href="{{ url_for('admin_panel') }}">Admin Panel</a>{% endif %}
        </p>
    </div>
</div>

<script src="{{ url_for('static', filename='theme.js') }}"></script>

<!-- Tag-adding AJAX script omitted for brevity -->

<script>
// Initialize tags array with current tags as a plain comma-separated string
const initialTags = {{ fic.tags | tojson }};
let tags = [...initialTags];

const tagsInput = document.getElementById("tags-input");
const tagsContainer = document.getElementById("tags-container");
const hiddenInput = document.getElementById("tags-hidden");
const form = document.getElementById("edit-form");

function updateHiddenInput() {
    // Save as comma-separated string
    hiddenInput.value = tags.join(", ");
}

function addTag(tag) {
    tag = tag.trim();
    if (tag && !tags.includes(tag)) {
        tags.push(tag);
        renderTags();
        updateHiddenInput();
    }
}

function removeTag(tag) {
    tags = tags.filter((t) => t !== tag);
    renderTags();
    updateHiddenInput();
}

function renderTags() {
    tagsContainer.innerHTML = "";
    tags.forEach((tag) => {
        const span = document.createElement("span");
        span.textContent = tag;
        span.style.border = "1px solid #ccc";
        span.style.borderRadius = "4px";
        span.style.padding = "4px 8px";
        span.style.margin = "4px";
        span.style.display = "inline-block";
        span.style.cursor = "pointer";
        span.title = "Click to remove";
        span.onclick = () => removeTag(tag);
        tagsContainer.appendChild(span);
    });
}

// Add tags on Enter or comma
document.getElementById("tags-input").addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === ",") {
        e.preventDefault();
        addTag(tagsInput.value);
        tagsInput.value = "";
    }
});

// On form submit, set the hidden input
document.querySelector("#edit-form").addEventListener("submit", () => {
    updateHiddenInput();
});

// Initialize display
renderTags();
</script>
</body>
</html>
