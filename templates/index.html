<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>kawfee.net</title>
        <link rel="icon" href="{{ url_for('static', filename='favicon.webp') }}" type="image/x-icon" />
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='index-style.css') }}"
        />
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
    </head>
    <body>
        <div class="container">
        <div class="site-header">
            <button
                type="button"
                id="theme-toggle"
                aria-label="Toggle dark mode"
                style="
                    background: none;
                    border: none;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                "
            >
                <!-- Sun icon (light mode) -->
                <svg
                    id="icon-sun"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    style="display: inline"
                >
                    <circle cx="12" cy="12" r="5" fill="currentColor"></circle>
                    <g stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line
                            x1="18.36"
                            y1="18.36"
                            x2="19.78"
                            y2="19.78"
                        ></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </g>
                </svg>
                <!-- Moon icon (dark mode) -->
                <svg
                    id="icon-moon"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    style="display: none"
                >
                    <path
                        d="M21 12.79A9 9 0 0112.21 3a7 7 0 100 14 9 9 0 008.79-4.21z"
                        fill="currentColor"
                    ></path>
                </svg>
            </button>
            {% if is_logged_in %}
            <p>
                Logged in as
                <a href="{{ url_for('profile') }}">{{ session['username'] }}</a>
            </p>
            {% else %}
            <p>
                <a href="{{ url_for('login') }}">Login</a> ---
                <a href="{{ url_for('register') }}">Register</a>
            </p>
            {% endif %}
        </div>
        <div
            style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                max-width: 1200px;
                margin: 0 auto 30px auto;
                margin-top: -10px;
            "
        >
            <h1 style="margin:0">kawfee.net</h1>
            <div style="display:flex">
            <form method="get" action="/">
              <!-- Search input for title, author, tags, fandoms -->
              <div style="width:500px; margin-right: -200px">
                <div>
                  <input
                    type="text"
                    name="search"
                    placeholder="Search by title, author, tags, fandoms"
                    value="{{ request.args.get('search', '') }}"
                  >
                </div>
                <!-- Specific Fandom search input -->
              </div>
              <!-- Submit button -->
              <div>
                <button type="submit">Search</button>
              </div>
            </form>
                {% if current_tag %}
                <input type="hidden" name="tag" value="{{ current_tag }}" />
                {% endif %}
            </div>
        </div>
        <div class="index-container">
            <div class="left-column">
                <div class="introduction">
                    <h1>{{ site_info.title }}</h1>
                    <p>{{ site_info.get('content', '')[:280] | replace('\n', '<br>') | safe }}... </p>
                    <a href="{{ url_for('about')}}">Read More</a>
                </div>
        <div class="tags-filter">
            <p><h3 style="margin:0">Top 5 Tags</h3></p>
            <ul>
              {% for tag in top_tags %}
                <li><a href="{{ url_for('filter_by_single_tag', tag=tag|urlencode) }}">{{ tag }}</a></li>
              {% endfor %}
            </ul>
              </div>
              <div class="update-container">
                  {% if latest_post %}
                      <div style="padding: 10px; overflow-y:auto;">
                          <h2 style="margin:0">Site Updates</h2>
                          <h3>{{ latest_post.title }}</h3>
                          <p><strong>By:</strong> {{ latest_post.author }}</p>
                          <p><strong>Published on:</strong> {{ latest_post.formatted_timestamp }}</p>
                          <p>{{  latest_post.content[:205] }}...</p>
                          <a href="{{ url_for('view_blog_post', post_id=latest_post.id) }}">Read More</a>
                      </div>
                  {% else %}
                      <p>No blog posts available.</p>
                  {% endif %}
              </div>

              {% if is_logged_in %}
              <div class="site-footer">
                  {% if show_back_link %}
                    <a href="{{ url_for('index') }}">Index</a> ---
                  {% endif %}
                  <a href="{{ url_for('logout') }}">Logout</a> ---
                  <a href="{{ url_for('submit') }}">Submit a fanfic</a>
                  {% if is_admin %} ---
                  <a href="{{ url_for('admin_panel') }}">Admin Panel</a>
                  {% endif %}
              </div>
              {% endif %}
            </div>
              <div class="fanfic-container">
                  <div style="margin-bottom:7px;text-align:right">
                    <span>Page {{ current_page }} of {{ total_pages }}</span>
                  </div>
                  <div class="fanfic-list">
                    {% if fanfics %}
                      {% for fic in fanfics %}
                        <div class="fic-card">
                            <div style="display:flex;justify-content:space-between">
                          <a id="fic-title" href="{{ url_for('view_fic', fid=fic.id) }}">{{ fic.title }}</a>
                              <div class="age-rating">
                              <p>{{ fic["age_rating"] if fic["age_rating"] else "N/A" }}</p>
                              </div>
                            </div>
                            <p style="margin-top: -5px">
                              by
                              <a href="{{ url_for('user_profile', username=fic.author) }}">{{ fic.author }}</a>
                            </p>
                          <p>
                            {% for tag in fic.tags %}
                              <span>{{ tag }}</span>
                            {% endfor %}
                          </p>
                           <p><strong>Fandom:</strong> {{ fic.fandom }}</p>

                        </div>
                      {% endfor %}
                    {% else %}
                      <p>No fanfics found.</p>
                    {% endif %}
                  </div>
                  <div class="pagination">
                    <div>
                      {% if current_page > 1 %}
                        <a href="{{ url_for('index', page=current_page-1, search=request.args.get('search'), author=request.args.get('author'), tag=request.args.get('tag')) }}">
                          Previous
                        </a>
                      {% endif %}
                    </div>

                    <div>
                      {% if current_page < total_pages %}
                        <a href="{{ url_for('index', page=current_page+1, search=request.args.get('search'), author=request.args.get('author'), tag=request.args.get('tag')) }}">
                          Next
                        </a>
                      {% endif %}
                    </div>
                  </div>
</div>
        </div>
        {% if show_policy_popup %}
        <script>
            if ({{ show_policy_popup|tojson }}) {
                if (confirm("The privacy policy has been updated. Do you accept?")) {
                    // User clicked OK, send AJAX to update version
                    fetch('/accept_changes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    }).then(response => {
                        if (response.ok) {
                            // Refresh or hide popup
                            location.reload();
                        } else {
                            alert('Error updating privacy policy.');
                        }
                    });
                }
            }
        </script>
        {% endif %}

        <script src="{{ url_for('static', filename='theme.js') }}"></script>

        <!-- Modal container -->
        <div id="privacyModal" class="modal" style="display:none">
          <div class="modal-content">
            <h3 style="margin:0; margin-top: 10px">TOS or Privacy Policy Updated</h3>
            <p>Our <a href="{{ url_for('privacy') }}">Privacy Policy</a> or our <a href="{{ url_for('tos') }}">Terms of Service</a> have been updated. This is a pop-up to make you aware of these changes,
                and to encourage you to review them carefully. Do you accept?
            </p>
            <button id="acceptBtn">Accept</button>
            <button id="declineBtn">Decline</button>
          </div>
        </div>
    </body>
</html>
